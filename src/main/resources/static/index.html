<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Chat AI</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="js/sockjs.min.js"></script>
    <script src="js/stomp.min.js"></script>
    <script src="js/markdown-it.js"></script>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/index.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
</head>
<body>
<div class="container">
    <div class="chat-container" id="chat">

    </div>
    <div class="message-area">
        <textarea cols="70" rows="3" id="user-input" placeholder="请输入你的问题..."></textarea>
        <button onclick="sendMessage()" id="send-button">发送</button>
        <button onclick="stopAnswering()" id="stop-button">停止回答</button>
    </div>
    <span class="author"><a href="https://lzh329279263.cn/home">lzh</a></span>
    <button onclick="clearMessage()" class="clear" ><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M8 20v-5h2v5h9v-7H5v7h3zm-4-9h16V8h-6V4h-4v4H4v3zM3 21v-8H2V7a1 1 0 0 1 1-1h5V3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v3h5a1 1 0 0 1 1 1v6h-1v8a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1z"></path></svg></button>
</div>

<script>
    const GROUP_KEY="group_id";
    const HISTORY_KEY="history_list";
    //自定义场景
    const SYSTEM_PROMPT="system_prompt";


    const userInputField = document.getElementById('user-input');
    const chat = document.getElementById('chat');
    userInputField.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            sendMessage();
            e.preventDefault();
        }
    });
    userInputField.addEventListener('input', function () {
        // 动态调整行数，但不能超过最大行数
        var currentRows = this.rows;
        var scrollHeight = this.scrollHeight;
        var lineHeight = this.clientHeight / currentRows; // 计算行高
        // 根据内容滚动高度计算需要的行数
        var newRows = Math.ceil(scrollHeight / lineHeight);
        // 限制行数在最大行数范围内
        newRows = Math.min(newRows, 8);
        // 更新rows属性
        if (newRows !== currentRows) {
            this.rows = newRows;
            chatScrollToBottom(chat);
        }
    });


    let groupId = (function (){
        return localStorage.getItem(GROUP_KEY) || generateUniqueID();
    })();
    localStorage.setItem(GROUP_KEY, groupId)
    let token = 'Bearer '+groupId;

    let md = markdownit();
    let map = {};
    var stompClient;


    function connect() {
        var socket = new SockJS("/chat_ai/pc/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({'Authorization': token}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/' + groupId, function (message) {
                let msgObj = JSON.parse(message.body);
                console.info(msgObj.content)
                if (msgObj.role === "user") {
                    userQuestion(msgObj);
                } else {
                    aiAnswer(msgObj);
                }
            });
        });

        // 监听连接断开事件
        socket.onclose = function () {
            console.log('WebSocket连接已关闭。正在尝试在5秒内重新连接...');
            setTimeout(connect, 5000); // 5秒后尝试重新连接
        };
    }

    connect();

    function userQuestion(msgObj) {
        let div = document.createElement("div");
        div.id = msgObj.msgId
        div.innerHTML = md.render(msgObj.content);
        div.classList.add('message', 'user-message');
        document.getElementById("chat").appendChild(div);
        chatScrollToBottom(chat);
    }

    function aiAnswer(msgObj) {
        let id = "ai" + msgObj.answerMsgId;
        if (msgObj.initialized) {
            let fromDiv = document.getElementById(msgObj.answerMsgId);
            let div = document.createElement("div");
            div.id = id;
            div.innerHTML = md.render((msgObj.content));
            div.classList.add('message', 'bot-message');
            map[id] = msgObj.content;
            // fromDiv.append(div);
            fromDiv.insertAdjacentElement("afterend", div);
        } else {
            let div = document.getElementById(id);
            if (!div) return
            map[id] = map[id] + msgObj.content
            div.innerHTML = md.render(map[id]);
            if (msgObj.completed) {
                aiAnswerComplete(div,id);
            }
        }
        chatScrollToBottom(chat);
    }

    function sendMessage() {
        let message = addMessageList({"role":"user","content":userInputField.value});
        stompClient.send("/chat/sendMessage/" + groupId, {}, message);
        userInputField.value = "";
        userInputField.rows = 3;
        answering();
    }

    function aiAnswerComplete(div,id) {
        createCopyBtnForCodeBlocks(div)
        addMessageList({"role":"assistant","content":map[id]});
        delete map[id]
        answerComplete();
        console.log("完成输出!")
    }
    function addMessageList(obj) {
        let history = getMessageList();
        history.push(obj)
        let result = JSON.stringify(history)
        localStorage.setItem(HISTORY_KEY,result)
        return result;
    }
    function getMessageList() {
        return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    }
    function answerComplete() {
        $('#send-button').show();
        $('#stop-button').hide();
    }
    function answering() {
        $('#send-button').hide();
        $('#stop-button').show();
    }
    answerComplete();
    function stopAnswering() {
        answerComplete();
        Object.keys(map).forEach((key)=>{
            stompClient.send("/chat/stopAnswering/" + key.split("ai")[1], {});
        });
    }

    function createMessageElement(msgObj) {
        let div = document.createElement("div");
        div.id = msgObj.id;
        div.innerHTML = md.render(msgObj.content);
        div.classList.add('message', msgObj.role === "user" ? 'user-message' : 'bot-message');
        return div;
    }


    function createCopyBtnForCodeBlocks(div) {
        // 获取所有code标签
        const codeElements = div.getElementsByTagName('code');
        // 遍历每个code标签并添加复制按钮
        Array.from(codeElements).forEach(codeElement => {
            // 检查code标签是否是代码块的一部分
            if (isCodeBlock(codeElement)) {
                let copyBtn = document.createElement('button');
                copyBtn.textContent = '复制该代码';
                copyBtn.classList.add('copy-btn');
                copyBtn.onclick = function () {
                    // 复制code标签内的内容
                    copyTextToClipboard(codeElement.textContent);
                };
                // 将复制按钮添加到code标签旁边
                codeElement.insertAdjacentElement('afterend', copyBtn);
            }
        });
    }

    // 在渲染消息后调用此函数
    function renderMessages(messages) {
        let chatContent = document.createDocumentFragment(); // 用于批量插入DOM
        for (const item of messages) {
            item.initialized = true;
            let messageElement = createMessageElement(item);
            chatContent.appendChild(messageElement);
        }
        // 批量插入所有消息元素
        chat.appendChild(chatContent);
        // 为每个消息的code块添加复制按钮
        const messageDivs = document.querySelectorAll('.message');
        messageDivs.forEach(div => createCopyBtnForCodeBlocks(div));
        chatScrollToBottom(chat);
    }

    renderMessages(getMessageList());

    function clearMessage() {
        localStorage.removeItem(HISTORY_KEY);
        chat.innerHTML="";
        $('body').notify('消息已清空');
    }

</script>
</body>
</html>
