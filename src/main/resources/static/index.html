<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat AI</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="js/sockjs.min.js"></script>
    <script src="js/stomp.min.js"></script>
    <script src="js/markdown-it.js"></script>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/index.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container">
    <div class="chat-container" id="chat">

    </div>
    <div class="bottom-message-send">
        <textarea cols="70" rows="8" id="user-input" placeholder="请输入你的问题..."></textarea>
        <button onclick="sendMessage()">发送</button>
    </div>
    <span class="author"><a href="https://lzh329279263.cn">luozhihui</a></span>
</div>

<script>
    const userInputField = document.getElementById('user-input');
    const chat = document.getElementById('chat');
    userInputField.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            sendMessage();
            e.preventDefault();
        }
    });
    let groupId = "1";
    let token = 'Bearer admin123';
    // var socket = new SockJS("http://localhost/chat_ai/ws");

    let md = markdownit();
    let map = {};
    var stompClient;


    function connect() {
        var socket = new SockJS("/chat_ai/pc/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({'Authorization': token}, function (frame) {
            console.log('Connected: ' + frame);

            stompClient.subscribe('/topic/' + groupId, function (message) {
                let msgObj = JSON.parse(message.body);
                console.info(msgObj.content)
                if (msgObj.role === "user") {
                    userQuestion(msgObj);
                } else {
                    aiAnswer(msgObj);
                }
            });
        });

        // 监听连接断开事件
        socket.onclose = function () {
            console.log('WebSocket连接已关闭。正在尝试在5秒内重新连接...');
            setTimeout(connect, 5000); // 5秒后尝试重新连接
        };
    }

    connect();

    function userQuestion(msgObj) {
        let div = document.createElement("div");
        div.id = msgObj.msgId
        div.innerHTML = md.render(msgObj.content);
        div.classList.add('message', 'user-message');
        document.getElementById("chat").appendChild(div);
        chatScrollToBottom(chat);
    }

    function aiAnswer(msgObj) {
        if (msgObj.initialized) {
            let fromDiv = document.getElementById(msgObj.answerMsgId);
            let div = document.createElement("div");
            let id = "ai" + msgObj.answerMsgId;
            div.id = id;
            div.innerHTML = md.render((msgObj.content));
            div.classList.add('message', 'bot-message');
            map[id] = msgObj.content;
            // fromDiv.append(div);
            fromDiv.insertAdjacentElement("afterend", div);
        } else {
            let id = "ai" + msgObj.answerMsgId;
            let div = document.getElementById(id);
            if (!div) return
            map[id] = map[id] + msgObj.content
            div.innerHTML = md.render(map[id]);
            if (msgObj.completed) {
                createCopyBtnForCodeBlocks(div)
                console.log("完成输出")
            }
        }
        chatScrollToBottom(chat);
    }

    function sendMessage() {
        stompClient.send("/chat/sendMessage/" + groupId, {}, userInputField.value);
        userInputField.value = "";
    }

    function createMessageElement(msgObj) {
        let div = document.createElement("div");
        div.id = msgObj.id;
        div.innerHTML = md.render(msgObj.content);
        div.classList.add('message', msgObj.role === "user" ? 'user-message' : 'bot-message');
        return div;
    }


    function createCopyBtnForCodeBlocks(div) {
        // 获取所有code标签
        const codeElements = div.getElementsByTagName('code');
        // 遍历每个code标签并添加复制按钮
        Array.from(codeElements).forEach(codeElement => {
            // 检查code标签是否是代码块的一部分
            if (isCodeBlock(codeElement)) {
                let copyBtn = document.createElement('button');
                copyBtn.textContent = '复制该代码';
                copyBtn.classList.add('copy-btn');
                copyBtn.onclick = function () {
                    // 复制code标签内的内容
                    copyTextToClipboard(codeElement.textContent);
                };
                // 将复制按钮添加到code标签旁边
                codeElement.insertAdjacentElement('afterend', copyBtn);
            }
        });
    }

    // 在渲染消息后调用此函数
    function renderMessages(messages) {
        let chatContent = document.createDocumentFragment(); // 用于批量插入DOM
        for (const item of messages) {
            item.initialized = true;
            let messageElement = createMessageElement(item);
            chatContent.appendChild(messageElement);
        }
        // 批量插入所有消息元素
        chat.appendChild(chatContent);
        // 为每个消息的code块添加复制按钮
        const messageDivs = document.querySelectorAll('.message');
        messageDivs.forEach(div => createCopyBtnForCodeBlocks(div));
        chatScrollToBottom(chat);
    }


    // 请求处理
    $.ajax({
        url: '/chat_ai/chat/getLatestByCurrentUser',
        type: 'GET',
        headers: {
            'Authorization': token,
        },
        success: function (res) {
            let data = res.data;
            groupId = data.id;
            renderMessages(data.messageRecordList); // 调用函数
        }
    });

</script>
</body>
</html>
